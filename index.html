<html>
    <head>
        <script>
            const msalConfig = {
                auth: {
                    clientId: "58d93311-0687-4204-9f71-802312070336",
                    authority: "https://login.microsoftonline.com/christopherfrenning.onmicrosoft.com",
                    //redirectUri: "https://agreeable-mud-0c21e7f03.azurestaticapps.net/",
                    redirectUri: "http://localhost:5501/"
                },
                cache: {
                    cacheLocation: "sessionStorage", // This configures where your cache will be stored
                    storeAuthStateInCookie: false, // Set this to "true" if you are having issues on IE11 or Edge
                }
                };

                // Add scopes here for ID token to be used at Microsoft identity platform endpoints.
                const loginRequest = {
                    scopes: ["https://management.azure.com/.default"]
                };

                // Add scopes here for access token to be used at Microsoft Graph API endpoints.
                const tokenRequest = {
                    scopes: ["https://management.azure.com/.default"]
                };

            function doAuthStuff(msal, account) {
                tokenRequest.account = account;
                msal.acquireTokenSilent(tokenRequest).then(tokenResponse => { 
                    console.log(tokenResponse);
                    doAzureStuff(tokenResponse.accessToken);
                });
            }

            async function doAzureStuff(token) {
                document.querySelector('#stuff').innerHTML = "Working on Azure stuff...";

                //const storageAccount = "https://v1xuyault.blob.core.windows.net";
                const azureManagementBaseUrl = "https://management.azure.com/subscriptions/?api-version=2020-06-01";
                
                const header_data = { 'Authorization' : 'Bearer ' + token}
                let result = await fetch(azureManagementBaseUrl, { headers : header_data });
                if ( result.ok ) {
                    let json = await result.json();
                    
                    var m = "<h2>Your subscriptions:</h2>";
                    json.value.forEach( sub => {
                        m += "<div>" + sub.displayName + "</div>";
                    });

                    document.querySelector('#stuff').innerHTML = m;
                }
                else {
                    // nah
                }
            }

        </script>

        <script src="https://alcdn.msauth.net/browser/2.0.0/js/msal-browser.js" crossorigin="anonymous"></script>
    </head>

    <body>
        <div id="hellomsg">Hello world!</div>
        <div id="stuff"></div>

        <script>
            const myMSALObj = new msal.PublicClientApplication(msalConfig);
            const currentAccounts = myMSALObj.getAllAccounts();
            if (currentAccounts === null) {
                //myMSALObj.loginRedirect(loginRequest);
                myMSALObj.loginPopup(loginRequest);
                // myMSALObj.loginPopup(loginRequest).then(handleResponse).catch(error => {
                //     console.error(error);
                // });
            }
            else if (currentAccounts.length == 1 ) {
                username = currentAccounts[0].username;
                document.querySelector('#hellomsg').innerHTML = "Hello, " + username;

                doAuthStuff(myMSALObj, currentAccounts[0]);

                //doAzureStuff();
            } 
            else {
                console.warn("spooky multiple accounts?");
            }
        </script>
    </body>

    
</html>